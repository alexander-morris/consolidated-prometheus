# Revised Centralized Integration Plan (o3)

> This plan supersedes the initial draft in `plan.md`.  It addresses cross-language realities, incremental rollout, and automation gaps discovered on deeper inspection of the repository.

---

## 0. Key Observations & Pain-Points

1. **Polyglot Codebase**  
   â€¢ Coordinator + Node ðŸ‘‰ **TypeScript / JavaScript**  
   â€¢ Docker agents ðŸ‘‰ **Python (Flask)**  
   â‡’ A single TS-only integration package will not satisfy all consumers.
2. **Signature-based Auth Already in Use**  
   Tokens are derived from `namespaceWrapper.payloadSigning`; JWT replacement isn't trivial.
3. **Duplicate Business Logic** between `node/worker` & `node/planner` (e.g. leader selection, utils).  
4. **Hard-coded Env URLs** (e.g. `middleServerUrl` in `constant.ts`) break reproducible tests.
5. **Missing Contract Source-of-Truth**  
   REST routes defined ad-hoc in Express & Flask without shared schema.
6. **Repo Uses Two Package Managers**  
   Yarn workspaces for TS; `pip` for Python.  Need a strategy to publish / consume shared artefacts.

---

## 1. Guiding Principles for Integration Layer

1. **Contract-First**: Maintain an _OpenAPI 3.1 spec_ in `integration/spec/` as the single source of truth.  
2. **Code-Generation**: Generate language-specific SDKs (TS & Python) from the spec via `openapi-generator`.  
3. **Loose Coupling**: Services keep their own repos but import generated client libs, avoiding runtime monolith.
4. **Incremental Migration**: Wrap existing endpoints first, then refactor internal logic.
5. **Environment Agnostic**: All URLs & secrets come from `.env` or Kubernetes/Docker secretsâ€”never hard-coded.
6. **Test-Driven**: Consumer-driven contract tests (PACT) to enforce compatibility.

---

## 2. Target Directory Layout

```
integration/
â”œâ”€â”€ spec/                # OpenAPI YAML files (one per service group)
â”‚   â”œâ”€â”€ coordinator.yaml
â”‚   â”œâ”€â”€ node.yaml
â”‚   â””â”€â”€ docker.yaml
â”œâ”€â”€ sdk/                 # Autogenerated artefacts (DO NOT EDIT)
â”‚   â”œâ”€â”€ typescript/
â”‚   â”‚   â”œâ”€â”€ coordinator/
â”‚   â”‚   â”œâ”€â”€ node/
â”‚   â”‚   â””â”€â”€ docker/
â”‚   â””â”€â”€ python/
â”‚       â”œâ”€â”€ coordinator/
â”‚       â”œâ”€â”€ node/
â”‚       â””â”€â”€ docker/
â”œâ”€â”€ auth/                # Lang-agnostic docs & json-schema for signatures
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ gen-sdks.sh      # calls openapi-generator for both langs
â”‚   â””â”€â”€ validate-spec.ts # lint & bundle spec files
â””â”€â”€ tests/
    â”œâ”€â”€ pact/
    â””â”€â”€ e2e/
```

*Generated SDKs* are published to:
- npm: `@prometheus-swarm/{coordinator,node,docker}-sdk`
- pypi: `prometheus_{coordinator,node,docker}_sdk`

---

## 3. Migration Roadmap

### Phase A â€“ Spec Authoring & Verification (Weeks 1-2)
- [ ] Catalogue current routes via script (`express-openapi-autogen`, `flask-smorest`) to create draft YAML.
- [ ] Manually fill gaps: request/response bodies, error codes, auth headers.
- [ ] Validate with `speccy` & sample traffic replays.

### Phase B â€“ SDK Generation & Smoke Tests (Weeks 3-4)
- [ ] Add `scripts/gen-sdks.sh`; CI step fails if specs or generated SDK drift.
- [ ] Replace **one** non-critical call in `node/planner` (`/planner/get-source-repo`) with SDK usage.
- [ ] Write Jest & PyTest smoke tests invoking SDK against dev server.

### Phase C â€“ Service Refactor (Weeks 5-8)
- [ ] Coordinator: Use TypeScript type-guards from SDK models; remove duplicate request validation.
- [ ] Nodes: Replace direct `fetch` with SDK; refactor env handling (`middleServerUrl` -> `process.env.COORDINATOR_URL`).
- [ ] Docker agents: Swap raw `requests` calls for Python SDK.

### Phase D â€“ Contract Testing & CI/CD (Weeks 9-10)
- [ ] Set up PACT broker; Nodes & Docker agents publish consumer contracts.
- [ ] Coordinator runs provider tests in CI before merge.
- [ ] Add GitHub Action to regenerate + publish SDKs on spec change.

### Phase E â€“ Clean-up & Documentation (Weeks 11-12)
- [ ] Remove outdated utils (e.g. duplicated `leader.ts`).
- [ ] Write developer guide: "How to bump API version & regenerate SDK".
- [ ] Archive legacy integration code.

---

## 4. Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Spec drift due to hotfixes | CI gate fails if code adds route not in spec. |
| Cross-language compatibility issues | Use shared JSONSchema in `auth/` for signature payloads; validate in both langs. |
| Large PR size overwhelms reviewers | Toggle `FEATURE_FLAG_SDK_MIGRATION` env to allow gradual switchover. |
| Hard-coded URLs persist | ESLint rule `no-literal-url` + `bandit` for Python. |

---

## 5. Immediate Action Items (This Sprint)

1. **Bootstrap Spec**: run route scrapers, commit draft OpenAPI under `integration/spec/`.
2. **CI Lint Job**: add `npx @redocly/cli lint integration/spec/*.yaml`.
3. **Env Refactor Hotspot**: Parametrize `node/planner/src/utils/constant.ts::middleServerUrl`.  
   ```12:15:node/planner/src/utils/constant.ts
   export const middleServerUrl = process.env.COORDINATOR_URL || "http://localhost:8080";
   ```
4. **Stakeholder Sign-off**: Share the spec with backend & agent teams for feedback.

---

## 6. Reference to Current Files

â€¢ Coordinator routes: `coordinator/middle-server/src/routes/routes.ts`  
â€¢ Node constant: `node/planner/src/utils/constant.ts` / `node/worker/src/utils/constant.ts`  
â€¢ Docker routes: `node/worker/orca-agent/src/server/routes/*.py`  
â€¢ Auth middleware: `coordinator/middle-server/src/middleware/auth.ts`

---

## 7. Expected Outcomes

âœ… **Single Source of Truth** for API contracts  
âœ… **Auto-generated, strongly-typed clients** in both TS & Python  
âœ… **End-to-end CI pipeline** preventing integration regressions  
âœ… **Reduced duplication** & easier onboarding for new contributors 